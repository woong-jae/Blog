---
title: "[JS] 옵저버 패턴 (Observer Pattern)" 
date: "2022-03-22 21:29"
emoji: "🔎"
category: "javascript"
---
## 옵저버 패턴?
옵저버 패턴은 객체의 상태 변화를 관찰하는 옵저버들의 목록을 객체에 등록해서 
상태 변화가 발생할 때마다 메서드 등을 통해 객체가 직접 목록의 각 옵저버에게 통지하도록 하는 디자인 패턴이다.
즉, **어떤 객체의 상태가 변하면 연관된 객체들에게 알림을 보내는 디자인 패턴**이다.

이 패턴의 핵심은 상태를 가진 객체(subject)인 '발행기관(publisher)'에 이 객체를 관찰하는 옵저버들인 '구독자(subscriber)'들을 등록시키는 것이다.
그리고 각각의 구독자들은 발행기관이 발생시키는 이벤트를 받아 처리한다. 이 때문에 **'발행/구독 모델'**이라고도 한다.

옵저버 패턴은 MVC 패러다임과 자주 결합되어 사용된다. 옵저버 패턴을 사용함으로써 MVC에서 모델과 뷰 사이를 느슨하게 연결할 수 있다.

React의 'Redux'나 Vue의 'Vuex' 같은 **중앙 집중식 저장소**가 옵저버 패턴에 기반을 둔다.

## 구현

<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8d/Observer.svg/1708px-Observer.svg.png" width="500px" />

위키에 있는 UML 다이어그램을 참고해서 **상태를 가지는 발행기관**을 구현해보자.

### 발행기관(Publisher)
발행기관은 구독자들을 등록(register), 제거(unregister)하는 기능, 이벤트가 발생했을 때 구독자들에게 알려주는 기능을 가진다.

또한 `state`에 접근할 수 있도록 `Proxy`를 통해 get 트랩을 설정했다.
```js
class Publisher {
    constructor(state) {
        this.state = state;
        this.subscriber = new Set();
        return new Proxy(this, {
            get(target, prop) {
                if(prop in target.state) return target.state[prop];
                else return target[prop];
            }
        });
    }
    
    registerSubscriber(subscriber) {
        this.subscriber.add(subscriber);
    }
    unregisterSubscriber(subscriber) {
        this.subscriber.delete(subscriber);
    }
    notifySubscribers() {
        this.subscriber.forEach(subscriber => subscriber.notify());
    }
    setState(newState) {
        this.state = { ...this.state, ...newState };
        this.notifySubscribers();
    }
}
```

### 구독자(Subscriber)
구독자는 발행기관에서 변화가 생겼을 때 하는 일인 `notify`를 정의해야 한다.
```js
class Subscriber {
    constructor(notify) {
        this.notify = notify;
    }
}
```

### 사용
정의한 발행기관과 구독자를 사용보자.
```js
let state = new Publisher({ a: 1, b: 2 });

let adder = new Subscriber(() => console.log(`a + b = ${state.a + state.b}`));
let multiplier = new Subscriber(() => console.log(`a * b = ${state.a * state.b}`));

state.registerSubscriber(adder);
state.registerSubscriber(multiplier);

state.notifySubscribers();
// -> a + b = 3
// -> a * b = 2
state.setState({ a: 3 });
// -> a + b = 5
// -> a * b = 6
state.unregisterSubscriber(multiplier);

state.setState({ b: 7 });
// -> a + b = 10
```
발행기관에 구독자를 구독시킨 후 상태를 바꿨을 때, 각 구독자는 변화한 상태에 대해 처리를 해주는 것을 볼 수 있다.

<br/>

참조:  
[Vanilla Javascript로 상태관리 시스템 만들기](https://junilhwang.github.io/TIL/Javascript/Design/Vanilla-JS-Store/#_2-observer-pattern%E1%84%8B%E1%85%A6-%E1%84%83%E1%85%A2%E1%84%92%E1%85%A2-%E1%84%8B%E1%85%B5%E1%84%92%E1%85%A2%E1%84%92%E1%85%A1%E1%84%80%E1%85%B5)  
<https://ko.wikipedia.org/wiki/%EC%98%B5%EC%84%9C%EB%B2%84_%ED%8C%A8%ED%84%B4>  
<https://lihano.tistory.com/19>

